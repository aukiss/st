<!doctype html>
<html lang="zh-CN"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>教师端 · 班级助手</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>
<header><h1>教师端 · 班级助手</h1>
  <div class="top-actions">
    <a class="button" href="/board.html">🏆 排行榜</a>
    <a class="button" id="logout">退出登录 👋</a>
  </div>
</header>
<main>
<div class="card"><h2>📚 1. 粘贴/更新答案库（文本）</h2>
<textarea id="ans" rows="6" placeholder="格式建议：题号. 题干 —— 标准答案"></textarea>
<button id="saveAns">保存为当前答案库</button><p id="ansMsg"></p></div>

<div class="card"><h2>📣 2. 发布广播</h2>
<input id="bTitle" placeholder="标题">
<textarea id="bBody" rows="3" placeholder="正文"></textarea>
<select id="aud"><option value="all">全体</option><option value="one">单个学生</option></select>
<input id="stuPhone" placeholder="学生手机号（当选择单个时）" inputmode="numeric">
<button id="sendB">📣 发布</button><p id="bMsg"></p></div>

<div class="card"><h2>👥 3. 学生列表</h2>
<table id="students"><thead><tr><th>昵称</th><th>手机号</th><th>角色</th><th>水平</th></tr></thead><tbody></tbody></table></div>
</main>
<script>
function me(){ try{ return JSON.parse(sessionStorage.getItem("me")||"{}"); }catch{return {};}}
if(!me().phone){ location.href="/"; }
function toast(msg, kind){const t=document.createElement('div');t.className='toast';t.textContent=(kind==='ok'?'✅ ':'')+(kind==='warn'?'⚠️ ':'')+(kind==='err'?'❌ ':'')+msg; if(kind==='ok')t.style.background='#16a34a'; if(kind==='warn')t.style.background='#f59e0b'; if(kind==='err')t.style.background='#dc2626'; document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .3s'; setTimeout(()=>t.remove(),320); }, 1800);}
async function api(u,opt={}){const r=await fetch(u,opt);const t=await r.json().catch(()=>({}));if(!r.ok)throw new Error(t.message||('HTTP '+r.status));return t;}
document.getElementById('logout').onclick=()=>{ sessionStorage.removeItem('me'); location.href='/'; };

// 保存答案库：进行中状态
document.getElementById('saveAns').onclick=async(e)=>{
  const btn=e.target; const body=document.getElementById('ans').value; 
  btn.disabled=true; const old=btn.textContent; btn.textContent='保存中…';
  try{
    const ret=await api('/.netlify/functions/answers',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({body, phone: me().phone})});
    toast('答案库已更新 ✅','ok'); document.getElementById('ansMsg').textContent=ret.message||'OK';
  }catch(err){ toast(err.message,'err'); }
  finally{ btn.disabled=false; btn.textContent=old; }
};

// 发布广播：进行中状态
document.getElementById('sendB').onclick=async(e)=>{
  const btn=e.target; const title=document.getElementById('bTitle').value; 
  const body=document.getElementById('bBody').value; const audience=document.getElementById('aud').value; 
  const student_phone=(document.getElementById('stuPhone').value||'').replace(/\D+/g,'');
  btn.disabled=true; const old=btn.textContent; btn.textContent='发布中…';
  try{
    const ret=await api('/.netlify/functions/broadcasts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,body,audience,student_phone, phone: me().phone})});
    toast('已发布到班级 📣','ok'); document.getElementById('bMsg').textContent=ret.message||'OK';
  }catch(err){ toast(err.message,'err'); }
  finally{ btn.disabled=false; btn.textContent=old; }
};

// 学生列表
async function loadStudents(){ const d=await api('/.netlify/functions/students'); const tbody=document.querySelector('#students tbody'); tbody.innerHTML=''; (d||[]).forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML='<td data-th="昵称">'+(s.name||'')+'</td><td data-th="手机号">'+(s.phone||'')+'</td><td data-th="角色">'+(s.role||'')+'</td><td data-th="水平">'+(s.level||'')+'</td>'; tbody.appendChild(tr); }); }
loadStudents();
</script>
</body></html>
