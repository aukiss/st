<!doctype html>
<html lang="zh-CN"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ•™å¸ˆç«¯ Â· ç­çº§åŠ©æ‰‹</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>
<header><h1>æ•™å¸ˆç«¯ Â· ç­çº§åŠ©æ‰‹</h1>
  <div class="top-actions">
    <a class="button" href="/board.html">ğŸ† æ’è¡Œæ¦œ</a>
    <a class="button" id="logout">é€€å‡ºç™»å½• ğŸ‘‹</a>
  </div>
</header>
<main>
<div class="card"><h2>ğŸ“š 1. ç²˜è´´/æ›´æ–°ç­”æ¡ˆåº“ï¼ˆæ–‡æœ¬ï¼‰</h2>
<textarea id="ans" rows="6" placeholder="æ ¼å¼å»ºè®®ï¼šé¢˜å·. é¢˜å¹² â€”â€” æ ‡å‡†ç­”æ¡ˆ"></textarea>
<button id="saveAns">ä¿å­˜ä¸ºå½“å‰ç­”æ¡ˆåº“</button><p id="ansMsg"></p></div>

<div class="card"><h2>ğŸ“£ 2. å‘å¸ƒå¹¿æ’­</h2>
<input id="bTitle" placeholder="æ ‡é¢˜">
<textarea id="bBody" rows="3" placeholder="æ­£æ–‡"></textarea>
<select id="aud"><option value="all">å…¨ä½“</option><option value="one">å•ä¸ªå­¦ç”Ÿ</option></select>
<input id="stuPhone" placeholder="å­¦ç”Ÿæ‰‹æœºå·ï¼ˆå½“é€‰æ‹©å•ä¸ªæ—¶ï¼‰" inputmode="numeric">
<button id="sendB">ğŸ“£ å‘å¸ƒ</button><p id="bMsg"></p></div>

<div class="card"><h2>ğŸ‘¥ 3. å­¦ç”Ÿåˆ—è¡¨</h2>
<table id="students"><thead><tr><th>æ˜µç§°</th><th>æ‰‹æœºå·</th><th>è§’è‰²</th><th>æ°´å¹³</th></tr></thead><tbody></tbody></table></div>
</main>
<script>
function me(){ try{ return JSON.parse(sessionStorage.getItem("me")||"{}"); }catch{return {};}}
if(!me().phone){ location.href="/"; }
function toast(msg, kind){const t=document.createElement('div');t.className='toast';t.textContent=(kind==='ok'?'âœ… ':'')+(kind==='warn'?'âš ï¸ ':'')+(kind==='err'?'âŒ ':'')+msg; if(kind==='ok')t.style.background='#16a34a'; if(kind==='warn')t.style.background='#f59e0b'; if(kind==='err')t.style.background='#dc2626'; document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .3s'; setTimeout(()=>t.remove(),320); }, 1800);}
async function api(u,opt={}){const r=await fetch(u,opt);const t=await r.json().catch(()=>({}));if(!r.ok)throw new Error(t.message||('HTTP '+r.status));return t;}
document.getElementById('logout').onclick=()=>{ sessionStorage.removeItem('me'); location.href='/'; };

// ä¿å­˜ç­”æ¡ˆåº“ï¼šè¿›è¡Œä¸­çŠ¶æ€
document.getElementById('saveAns').onclick=async(e)=>{
  const btn=e.target; const body=document.getElementById('ans').value; 
  btn.disabled=true; const old=btn.textContent; btn.textContent='ä¿å­˜ä¸­â€¦';
  try{
    const ret=await api('/.netlify/functions/answers',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({body, phone: me().phone})});
    toast('ç­”æ¡ˆåº“å·²æ›´æ–° âœ…','ok'); document.getElementById('ansMsg').textContent=ret.message||'OK';
  }catch(err){ toast(err.message,'err'); }
  finally{ btn.disabled=false; btn.textContent=old; }
};

// å‘å¸ƒå¹¿æ’­ï¼šè¿›è¡Œä¸­çŠ¶æ€
document.getElementById('sendB').onclick=async(e)=>{
  const btn=e.target; const title=document.getElementById('bTitle').value; 
  const body=document.getElementById('bBody').value; const audience=document.getElementById('aud').value; 
  const student_phone=(document.getElementById('stuPhone').value||'').replace(/\D+/g,'');
  btn.disabled=true; const old=btn.textContent; btn.textContent='å‘å¸ƒä¸­â€¦';
  try{
    const ret=await api('/.netlify/functions/broadcasts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title,body,audience,student_phone, phone: me().phone})});
    toast('å·²å‘å¸ƒåˆ°ç­çº§ ğŸ“£','ok'); document.getElementById('bMsg').textContent=ret.message||'OK';
  }catch(err){ toast(err.message,'err'); }
  finally{ btn.disabled=false; btn.textContent=old; }
};

// å­¦ç”Ÿåˆ—è¡¨
async function loadStudents(){ const d=await api('/.netlify/functions/students'); const tbody=document.querySelector('#students tbody'); tbody.innerHTML=''; (d||[]).forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML='<td data-th="æ˜µç§°">'+(s.name||'')+'</td><td data-th="æ‰‹æœºå·">'+(s.phone||'')+'</td><td data-th="è§’è‰²">'+(s.role||'')+'</td><td data-th="æ°´å¹³">'+(s.level||'')+'</td>'; tbody.appendChild(tr); }); }
loadStudents();
</script>
</body></html>
