<!doctype html>
<html lang="zh-CN"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>å­¦ç”Ÿç«¯ Â· è½»æ¾å­¦æ•°å­¦</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>
<header><h1>å­¦ç”Ÿç«¯ Â· è½»æ¾å­¦æ•°å­¦</h1>
  <div class="top-actions">
    <a class="button" href="/board.html">ğŸ† æ’è¡Œæ¦œ</a>
    <a class="button" id="logout">é€€å‡ºç™»å½• ğŸ‘‹</a>
  </div>
</header>
<main>
<div class="card">
  <h2>ğŸ§‘â€ğŸ“ ä¸ªäººèµ„æ–™</h2>
  <div class="row">
    <div><label>ğŸ­ æ˜µç§°</label><input id="nick" placeholder="å¯è‡ªå®šä¹‰"/></div>
    <div><label>ğŸ“ˆ å­¦ä¹ æ°´å¹³</label><select id="level"><option>ç®€å•</option><option selected>ä¸­ç­‰</option><option>æ‹”é«˜</option></select></div>
  </div>
  <button id="saveProfile">ä¿å­˜èµ„æ–™</button>
  <p class="muted" id="pMsg"></p>
</div>

<div class="card">
  <h2>ğŸ“· 1. ä¸Šä¼ ä½œä¸š</h2>
  <input type="file" id="file" accept="image/*,application/pdf" capture="environment">
  <div class="top-actions" style="margin-top:8px">
    <button id="upload">ğŸ“¤ ä¸Šä¼ å­˜æ¡£</button>
    <button id="ocr">ğŸ” OCR è¯†åˆ«</button>
    <button id="checkin">âœ… ä»Šæ—¥æ‰“å¡</button>
  </div>
  <progress id="pg" value="0" max="100" style="display:none"></progress>
  <textarea id="submission" rows="6" placeholder="ä¹Ÿå¯ä»¥ç›´æ¥æŠŠç­”æ¡ˆæ–‡æœ¬ç²˜è´´åœ¨è¿™é‡Œ~"></textarea>
  <button id="grade">ğŸ§  æäº¤å¹¶è‡ªåŠ¨æ‰¹æ”¹</button><p id="msg"></p>
  <div class="hint">æ‰¹æ”¹é€šå¸¸éœ€è¦ 20~60 ç§’ï¼›è¿‡ç¨‹ä¸­æŒ‰é’®ä¼šå˜ç°å¹¶æ˜¾ç¤ºâ€œæ­£åœ¨è¿›è¡Œâ€¦â€ã€‚</div>
</div>

<div class="card"><h2>ğŸ“˜ 2. æˆ‘çš„é”™é¢˜æœ¬</h2>
<table id="mistakes"><thead><tr><th>é¢˜ç›®</th><th>æˆ‘çš„ç­”æ¡ˆ</th><th>ç»“è®º</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div>

<div class="card">
  <h2>ğŸ—“ï¸ 3. å¤ä¹ è®¡åˆ’ï¼ˆç®€å• / ä¸­ç­‰ / æ‹”é«˜ï¼‰</h2>
  <div class="top-actions"><button data-lv="ç®€å•">ç”Ÿæˆç®€æ˜“å¤ä¹ </button><button data-lv="ä¸­ç­‰">ç”Ÿæˆä¸­ç­‰å¤ä¹ </button><button data-lv="æ‹”é«˜">ç”Ÿæˆæ‹”é«˜å¤ä¹ </button></div>
  <pre id="plan"></pre>
</div>

<div class="card"><h2>ğŸ“£ 4. å…¬å‘Š</h2><ul id="casts"></ul></div>
</main>
<script>
function me(){ try{ return JSON.parse(sessionStorage.getItem("me")||"{}"); }catch{return {};}} if(!me().phone){ location.href="/"; }
function toast(msg, kind){const t=document.createElement('div');t.className='toast';t.textContent=(kind==='ok'?'âœ… ':'')+(kind==='warn'?'âš ï¸ ':'')+(kind==='err'?'âŒ ':'')+msg; if(kind==='ok')t.style.background='#16a34a'; if(kind==='warn')t.style.background='#f59e0b'; if(kind==='err')t.style.background='#dc2626'; document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .3s'; setTimeout(()=>t.remove(),320); }, 1800);}
async function api(u,opt={}){const r=await fetch(u,opt);const t=await r.json().catch(()=>({}));if(!r.ok)throw new Error(t.message||('HTTP '+r.status));return t;}
document.getElementById('logout').onclick=()=>{ sessionStorage.removeItem('me'); location.href='/'; };

// â€”â€” èµ„æ–™ä¿å­˜ï¼šæœ‰â€œè¿›è¡Œä¸­â€çŠ¶æ€
document.getElementById('saveProfile').onclick=async(e)=>{ const btn=e.target; const name=document.getElementById('nick').value.trim(); const level=document.getElementById('level').value; btn.disabled=true; const old=btn.textContent; btn.textContent='ä¿å­˜ä¸­â€¦'; try{ const ret=await api('/.netlify/functions/profile',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:me().phone,name,level})}); if(ret.ok){ toast('èµ„æ–™å·²ä¿å­˜ âœ…','ok'); } else { toast(ret.message||'ä¿å­˜å¤±è´¥ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰','warn'); } document.getElementById('pMsg').textContent='å·²ä¿å­˜'; }catch(e){ toast(e.message,'err'); } finally{ btn.disabled=false; btn.textContent=old; } };

// å…¬å‘Šä¸é”™é¢˜åŠ è½½
async function loadCasts(){ const d=await api('/.netlify/functions/broadcasts'); const ul=document.getElementById('casts'); ul.innerHTML=''; (d||[]).forEach(x=>{ const li=document.createElement('li'); li.textContent=(new Date(x.created_at).toLocaleString())+' Â· '+x.title+'ï¼š'+x.body; ul.appendChild(li); }); }
async function loadMistakes(){ const d=await api('/.netlify/functions/mistakes?phone='+encodeURIComponent(me().phone)); const tb=document.querySelector('#mistakes tbody'); tb.innerHTML=''; (d||[]).forEach(m=>{ const tr=document.createElement('tr'); tr.innerHTML='<td data-th="é¢˜ç›®">'+(m.q_text||'')+'</td><td data-th="æˆ‘çš„ç­”æ¡ˆ">'+(m.user_answer||'')+'</td><td data-th="ç»“è®º"><span class="pill">'+(m.result||'')+'</span></td><td data-th="æ“ä½œ"><button data-id="'+m.id+'" class="tutor">ğŸ“˜ é”™é¢˜è¾…å¯¼</button> <button data-id="'+m.id+'" class="resolve">ğŸŸ¢ å·²æ”¹å¯¹</button></td>'; tb.appendChild(tr); }); document.querySelectorAll('.tutor').forEach(b=>b.onclick=async(e)=>{ const btn=e.target; btn.disabled=true; const old=btn.textContent; btn.textContent='ç”Ÿæˆä¸­â€¦'; const id=b.getAttribute('data-id'); try{ const r=await api('/.netlify/functions/tutor?id='+id+'&phone='+encodeURIComponent(me().phone)); toast('å·²ç”Ÿæˆè¾…å¯¼å¡ âœ…','ok'); alert(r.card||'å·²ç”Ÿæˆè¾…å¯¼å¡'); }catch(e){ toast(e.message,'err'); } finally{ btn.disabled=false; btn.textContent=old; } }); document.querySelectorAll('.resolve').forEach(b=>b.onclick=async(e)=>{ const btn=e.target; btn.disabled=true; const old=btn.textContent; btn.textContent='æäº¤ä¸­â€¦'; const id=b.getAttribute('data-id'); try{ await api('/.netlify/functions/resolve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id, phone: me().phone})}); toast('å¥½æ ·çš„ï¼Œå·²æ ‡è®°ä¸ºæ”¹å¯¹ï¼','ok'); loadMistakes(); }catch(e){ toast(e.message,'err'); } finally{ btn.disabled=false; btn.textContent=old; } }); }
loadCasts(); loadMistakes();

// ä¸Šä¼ ï¼šè¿›è¡Œä¸­çŠ¶æ€
async function toBase64(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result.split(',')[1]);fr.onerror=rej;fr.readAsDataURL(file);});}
document.getElementById('upload').onclick=async(e)=>{ const btn=e.target; const f=document.getElementById('file').files[0]; if(!f){toast('å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„ç…§ç‰‡æˆ–PDFå“¦~','warn');return;} btn.disabled=true; const old=btn.textContent; btn.textContent='ä¸Šä¼ ä¸­â€¦'; try{ const b64=await toBase64(f); const r=await api('/.netlify/functions/upload',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:f.name, contentType:f.type||'application/octet-stream', data:b64, phone: me().phone})}); toast('ä¸Šä¼ å®Œæˆ âœ…','ok'); document.getElementById('msg').textContent='å·²ä¸Šä¼ ï¼š'+r.key; }catch(e){ toast(e.message,'err'); } finally{ btn.disabled=false; btn.textContent=old; } };

// OCRï¼šè¿›è¡Œä¸­çŠ¶æ€ + tesseract v2
async function ocrImage(file){ const { data:{ text } } = await Tesseract.recognize(file, 'chi_sim'); return text; }
async function ocrPdf(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  const pages = Math.min(pdf.numPages, 3);
  let text='';
  for(let i=1;i<=pages;i++){
    const p = await pdf.getPage(i);
    const v = p.getViewport({ scale: 1.8 });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = v.width; canvas.height = v.height;
    await p.render({ canvasContext: ctx, viewport: v }).promise;
    const blob = await new Promise(r=>canvas.toBlob(r));
    const { data:{ text: t } } = await Tesseract.recognize(blob, 'chi_sim');
    text += "\n\nâ€”â€” ç¬¬"+i+"é¡µ â€”â€”\n"+t;
    document.getElementById('pg').value = Math.round(i/pages*100);
  }
  return text;
}
document.getElementById('ocr').onclick=async(e)=>{
  const btn=e.target; const f=document.getElementById('file').files[0]; if(!f){toast('å…ˆé€‰æ‹©å›¾ç‰‡æˆ–PDF~','warn');return;}
  const pg=document.getElementById('pg'); pg.style.display='block'; pg.value=0;
  btn.disabled=true; const old=btn.textContent; btn.textContent='è¯†åˆ«ä¸­â€¦';
  document.getElementById('msg').textContent='æ­£åœ¨OCRï¼Œè¯·ç¨å€™â€¦';
  try{
    const text = f.type && f.type.includes('pdf') ? await ocrPdf(f) : await ocrImage(f);
    document.getElementById('submission').value=(document.getElementById('submission').value+'\n'+text).trim();
    document.getElementById('msg').textContent='OCRå®Œæˆï¼Œå·²å†™å…¥æ–‡æœ¬æ¡†';
  }catch(e){ toast(e.message,'err'); document.getElementById('msg').textContent='OCRå¤±è´¥'; }
  finally{ pg.style.display='none'; btn.disabled=false; btn.textContent=old; }
};

// è®¡åˆ’ï¼šè¿›è¡Œä¸­çŠ¶æ€
document.querySelectorAll('[data-lv]').forEach(b=>b.onclick=async(e)=>{
  const btn=e.target; const lv=btn.getAttribute('data-lv');
  btn.disabled=true; const old=btn.textContent; btn.textContent='ç”Ÿæˆä¸­â€¦';
  api('/.netlify/functions/plan?level='+encodeURIComponent(lv)+'&phone='+encodeURIComponent(me().phone))
    .then(r=>{ document.getElementById('plan').textContent=r.plan||'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•'; })
    .catch(err=>toast(err.message,'err'))
    .finally(()=>{ btn.disabled=false; btn.textContent=old; });
});

// æ‰¹æ”¹ï¼šè¿›è¡Œä¸­çŠ¶æ€ + å®Œæˆååˆ·æ–°é”™é¢˜æœ¬
document.getElementById('grade').onclick=async(e)=>{
  const btn=e.target; const submission=document.getElementById('submission').value.trim();
  if(!submission){toast('è¯·å…ˆç²˜è´´æ–‡æœ¬æˆ–è¿›è¡Œ OCR è¯†åˆ«~','warn');return;}
  btn.disabled=true; const old=btn.textContent; btn.textContent='â³ æ­£åœ¨æ‰¹æ”¹ï¼ˆ20~60ç§’ï¼‰â€¦';
  document.getElementById('msg').textContent='æ­£åœ¨æäº¤åˆ°è€å¸ˆç³»ç»Ÿåˆ¤é¢˜â€¦';
  try{
    const r=await api('/.netlify/functions/grade',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({submission, phone: me().phone})});
    if(r.data){ toast('æ‰¹æ”¹å®Œæˆ âœ…','ok'); } else { toast(r.message||'æ‰¹æ”¹å®Œæˆï¼ˆå®‰å…¨æ¨¡å¼ï¼‰','warn'); }
    loadMistakes();
  }catch(e){ toast(e.message,'err'); }
  finally{ btn.disabled=false; btn.textContent=old; }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.min.js"></script>
</body></html>
